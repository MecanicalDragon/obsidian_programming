Теорема CAP известна также как теорема Брюера, поскольку впервые была сформулирована профессором Эриком А. Брюером в 2000 году: любая распределенная система не может гарантировать сразу все три свойства:
- **Consistency** - все узлы системы видят одни и те же данные в одно и то же время. После записи все последующие чтения вернут новое значение.
- **Availability** - каждый запрос (на чтение или запись) получит ответ — даже если часть системы недоступна.
- **Partition Tolerance** - система продолжает работать, даже если сообщения между узлами теряются или происходит сетевое разделение.

**Согласованность** означает, что все клиенты обладают доступом к одним и тем же данным в одно и то же время вне зависимости от того, к какому узлу они подключены. Чтобы это стало возможным, каждый раз при записи данных на одном узле необходимо обеспечить их мгновенную пересылку или репликацию между всеми остальными узлами в системе, после чего запись будет считаться успешной.

**Доступность** означает, что обработка всех запросов от клиентов гарантируется даже в том случае, если отдельные узлы недоступны. Другое определение: все активные узлы в распределенной системе возвращают допустимый ответ на любой запрос без каких-либо исключений.

**Устойчивость к разделению** означает, что в случае потерянного или временно приостановленного соединения между узлами системы кластер должен продолжать работать, несмотря на любое число нарушений связи.

[[NoSQL Databases]] масштабируются горизонтально и по определению являются распределёнными — их можно быстро масштабировать в растущей сети, состоящей из нескольких взаимосвязанных узлов. Сегодня базы данных NoSQL классифицируются в зависимости от пары практически поддерживаемых характеристик CAP:

- **База данных CP** обеспечивает согласованность и устойчивость к разделению в ущерб доступности. Если возникает разделение между двумя узлами, то система вынуждена завершить работу несогласованного узла (сделать его недоступным) до тех пор, пока разделение не будет устранено. Hbase – поколоночная master-slave бд.

- **База данных AP** обеспечивает доступность и устойчивость к разделению в ущерб согласованности. Если возникает разделение, все узлы остаются доступными, однако часть узлов могут возвращать не актуальную версию данных. После устранения разделения базы данных AP выполняют синхронизацию всех узлов, чтобы восстановить согласованность системы. CouchDB – мультимастерная документоориентированная бд. Redis – AP бд.

- **База данных CA** обеспечивает согласованность и доступность всех узлов. Однако, в распределённой системе разделение игнорировать попросту не получается, ибо если оно случится, остальные 2 требования тоже не соблюдаются. Поэтому можно рассматривать базу данных CA с теоретической точки зрения, однако практическая реализация распределённой базы данных CA не имеет смысла. Тем не менее, это не означает, что нельзя создать базу данных CA для распределённого приложения, если такая необходимость возникнет. Многие реляционные базы данных, такие как PostgreSQL, обеспечивают согласованность и доступность, и допускают развёртывание на нескольких узлах с помощью механизмов репликации.

### Теорема CAP (CP) и MongoDB

MongoDB — NoSQL DB, в которой данные хранятся в виде документов BSON (бинарный JSON). Она часто используется для больших данных и динамических приложений, работающих в нескольких разных расположениях. В контексте теоремы CAP база данных MongoDB представляет собой хранилище данных CP — она отличается устойчивостью к разделению и обеспечивает согласованность, но не гарантирует доступность.

MongoDB — это система, в которой каждый набор реплик может иметь только один главный узел, принимающий все операции записи. Все остальные узлы в том же наборе реплик выполняют роль вспомогательных узлов — они получают от главного узла копию журнала операций и применяют ее к своим наборам данных. По умолчанию клиенты отправляют запросы на чтение главному узлу, однако они могут настроить параметры предпочтения чтения, позволяющие обращаться для этой цели к вспомогательным узлам.

В случае потери доступа к главному узлу вспомогательный узел с самой последней версией журнала операций выбирается в качестве нового главного узла. После того как все остальные вспомогательные узлы зарегистрируются на новом главном узле, доступ к кластеру восстанавливается. Поскольку в течение этого времени запросы на запись от клиентов не принимаются, данные остаются согласованными во всей сети.

### Теорема CAP (AP) и Cassandra

[Apache Cassandra](https://www.bigdataschool.ru/wiki/cassandra) — это колоночная база данных, позволяющая хранить данные в распределённой сети. Но в отличие от MongoDB, Cassandra имеет архитектуру без главных узлов, что приводит к увеличению числа точек отказа. Распределение данных между узлами в Cassandra происходит по принципу [[Consistent Hashing]].

В контексте теоремы CAP база данных Cassandra представляет собой хранилище данных AP — она обеспечивает доступность и устойчивость к разделению, но не гарантирует согласованность. Поскольку Cassandra не имеет главного узла, все остальные узлы должны все время оставаться доступными. Однако, Cassandra предлагает модель согласованности в конечном счёте — клиенты могут записывать данные на любые узлы в любое время с максимально быстрым устранением несоответствий.

Поскольку несоответствие данных может возникнуть только в случае сетевого разделения и согласованность быстро восстанавливается, Cassandra предоставляет функцию исправления, помогающую узлам вернуться в актуальное состояние. Постоянная готовность позволяет получить высокопроизводительную систему, что во многих случаях перевешивает все недостатки. [Тут немного подробностей](https://www.youtube.com/watch?v=I6jB0nM9SKU&ab_channel=ByteByteGo) о том, как работает Кассандра.
